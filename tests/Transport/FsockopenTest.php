<?php

namespace Requests\Tests\Transport;

use Requests;
use Requests\Tests\Transport\BaseTestCase;
use Requests_Exception;
use Requests_Hooks;
use Requests_Transport_fsockopen;

class FsockopenTest extends BaseTestCase {
	protected $transport = Requests_Transport_fsockopen::class;

	public function testBadIP() {
		$this->expectException(Requests_Exception::class);
		parent::testBadIP();
	}

	public function testExpiredHTTPS() {
		$this->expectException(Requests_Exception::class);
		$this->expectExceptionMessage('SSL certificate did not match the requested domain name');
		parent::testExpiredHTTPS();
	}

	public function testRevokedHTTPS() {
		$this->expectException(Requests_Exception::class);
		$this->expectExceptionMessage('SSL certificate did not match the requested domain name');
		parent::testRevokedHTTPS();
	}

	/**
	 * Test that SSL fails with a bad certificate
	 */
	public function testBadDomain() {
		$this->expectException(Requests_Exception::class);
		$this->expectExceptionMessage('SSL certificate did not match the requested domain name');
		parent::testBadDomain();
	}

	/**
	 * Issue #248.
	 */
	public function testContentLengthHeader() {
		$hooks = new Requests_Hooks();
		$hooks->register('fsockopen.after_headers', array($this, 'checkContentLengthHeader'));

		Requests::post(httpbin('/post'), array(), array(), $this->getOptions(array('hooks' => $hooks)));
	}

	/**
	 * Issue #248.
	 */
	public function checkContentLengthHeader($headers) {
		$this->assertStringContainsString('Content-Length: 0', $headers);
	}
}
